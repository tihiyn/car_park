<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Информация об автомобиле</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-5">
    <!-- Заголовок -->
    <h2 class="text-center mb-4">Информация об автомобиле</h2>

    <!-- Характеристики авто -->
    <form th:object="${vehicle}" method="post" class="row g-3">
        <!-- Левая колонка -->
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Регистрационный номер</label>
                <input type="text" th:field="*{regNum}" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Пробег, км</label>
                <input type="number" th:field="*{mileage}" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Цвет</label>
                <input type="text" th:field="*{color}" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Дата и время покупки</label>
                <input type="text" id="purchaseDatetime" th:value="${vehicle.purchaseDatetime}" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Список водителей</label>
                <input type="text" th:field="*{drivers}" class="form-control" readonly>
            </div>
        </div>

        <!-- Правая колонка -->
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Стоимость, ₽</label>
                <input type="number" th:field="*{price}" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Год производства</label>
                <input type="number" th:field="*{productionYear}" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Доступность</label>
                <input type="text" th:field="*{isAvailable}" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Бренд</label>
                <input type="text" th:field="*{brand}" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Активный водитель</label>
                <input type="text" th:field="*{activeDriver}" class="form-control" readonly>
            </div>
        </div>

        <div class="col-md-6">
            <!-- Кнопки "Редактировать" и "К списку предприятий" -->
            <div class="mb-3 d-flex gap-2">
                <a th:href="@{/api/ui/vehicles/edit/{id}(id=${vehicle.id})}" class="btn btn-primary">Редактировать</a>
                <a href="/api/ui/enterprises" class="btn btn-secondary">К списку предприятий</a>
            </div>
        </div>
    </form>

    <h2 class="text-center mb-4">Информация о поездках</h2>

    <div class="row justify-content-center mb-4">
        <div class="col-auto d-flex align-items-center">
            <label for="fromDate" class="form-label me-2">C</label>
            <input type="datetime-local" id="fromDate" name="fromDate" class="form-control">
        </div>
        <div class="col-auto d-flex align-items-center">
            <label for="toDate" class="form-label me-2">До</label>
            <input type="datetime-local" id="toDate" name="toDate" class="form-control">
        </div>
        <div class="col-auto align-self-end">
            <button id="loadTrips" type="button" class="btn btn-primary">Показать</button>
        </div>
    </div>

    <hr class="my-4"/>

    <div id="trips" class="mt-3"></div>

    <section class="mt-5">
        <h2 class="text-center mb-4">Загрузить поездку</h2>
        <form
                th:action="@{/trips/save(id=${vehicle.id})}"
                method="post"
                enctype="multipart/form-data"
                id="uploadTripForm">

            <div class="mb-3">
                <label for="tripFile" class="form-label">Выберите GPX-файл:</label>
                <input
                        type="file"
                        class="form-control"
                        id="tripFile"
                        name="file"
                        accept=".gpx"
                        required>
            </div>

            <button type="submit" class="btn btn-primary">
                Загрузить
            </button>
        </form>

        <!-- Блок для отображения результата -->
        <div id="uploadStatus" class="mt-3"></div>
    </section>


    <!-- скрытое поле с id авто -->
    <input type="hidden" id="vehicleId" th:value="${vehicle.id}"/>
</div>

<script>
    // Перевод даты-времени покупки в таймзону клиента
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("purchaseDatetime");
        if (input && input.value) {
            input.value = new Date(input.value).toLocaleString();
        }
    })

    // Загрузка поездок
    document.getElementById('loadTrips').addEventListener('click', () => {
        const vehicleId = document.getElementById("vehicleId").value;
        const from = toUTCString(document.getElementById('fromDate').value);
        const to = toUTCString(document.getElementById('toDate').value);

        fetch(`/trips?id=${vehicleId}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById('trips').innerHTML = html;
                initTripsBlock(); // сразу активируем даты + кнопку
            });
    });

    // Перевод даты-времени из клиентского в UTC
    function toUTCString(localDateTimeStr) {
        const localDate = new Date(localDateTimeStr);
        return localDate.toISOString();
    }

    // Функция конвертации дат-времени начала и конца поездки
    function convertTripDates() {
        document.querySelectorAll(".beginTS").forEach(el => {
            if (el.textContent) {
                el.textContent = new Date(el.textContent).toLocaleString();
            }
        });
        document.querySelectorAll(".endTS").forEach(el => {
            if (el.textContent) {
                el.textContent = new Date(el.textContent).toLocaleString();
            }
        });
    }

    // Подключение обработчиков внутри блока trips
    function initTripsBlock() {
        convertTripDates();

        const showOnMapBtn = document.getElementById('showOnMap');
        if (showOnMapBtn) {
            showOnMapBtn.addEventListener('click', () => {
                const selected = Array.from(document.querySelectorAll('.trip-checkbox:checked'))
                    .map(cb => cb.value);

                if (selected.length === 0) {
                    alert("Выберите хотя бы одну поездку!");
                    return;
                }

                // Формируем query string: ?ids=12,15,27
                const params = new URLSearchParams();
                params.set("ids", selected.join(","));

                // Переход на страницу с картой
                window.location.href = "/map.html?" + params.toString();
            });
        }
    }

    document.getElementById("uploadTripForm").addEventListener("submit", async function(e) {
        e.preventDefault();

        const form = e.target;
        const fileInput = document.getElementById("tripFile");
        const status = document.getElementById("uploadStatus");

        if (!fileInput.files.length) {
            status.textContent = "Пожалуйста, выберите файл.";
            return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        status.textContent = "Загрузка...";

        try {
            const response = await fetch(form.action, {
                method: "POST",
                body: formData
            });

            if (response.ok) {
                status.textContent = "Файл успешно загружен!";
                status.className = "text-success mt-2";
            } else {
                const text = await response.text();
                status.textContent = "Ошибка загрузки: " + text;
                status.className = "text-danger mt-2";
            }
        } catch (error) {
            status.textContent = "Ошибка соединения с сервером.";
            status.className = "text-danger mt-2";
        }
    });
</script>
</body>
</html>
