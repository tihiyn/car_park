<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:,">
    <title>Редактировать транспортное средство</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">Редактировать транспортное средство</h1>
    <form th:action="@{/vehicles/save}" th:object="${vehicle}" method="post" id='vehicleForm' class="row g-3">
        <input type="hidden" th:value="${vehicle.id}" name="id" />
        <div class="col-md-6">
            <label for="regNum" class="form-label">Регистрационный номер</label>
            <input type="text" th:field="*{regNum}" class="form-control" id="regNum" required>
        </div>
        <div class="col-md-6">
            <label for="price" class="form-label">Стоимость, ₽</label>
            <input type="number" th:field="*{price}" class="form-control" id="price" min="100000" max="50000000" step="1000" required>
        </div>
        <div class="col-md-6">
            <label for="mileage" class="form-label">Пробег, км</label>
            <input type="number" th:field="*{mileage}" class="form-control" id="mileage" min="0" step="1000" required>
        </div>
        <div class="col-md-6">
            <label for="productionYear" class="form-label">Год производства</label>
            <input type="number" th:field="*{productionYear}" class="form-control" id="productionYear" min="1900" max="2025" required>
        </div>
        <div class="col-md-6">
            <label for="color" class="form-label">Цвет</label>
            <input type="text" th:field="*{color}" class="form-control" id="color" required>
        </div>
        <div class="col-md-6">
            <label for="available" class="form-label">Доступность</label>
            <select th:field="*{available}" class="form-select" id="available">
                <option value="true">Да</option>
                <option value="false">Нет</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="datetimeInput" class="form-label">Дата и время покупки</label>
            <input type="datetime-local"
                   th:data-utc="${vehicle.purchaseDatetime}"
                   class="form-control" id="datetimeInput" required>
            <input type="hidden" name="purchaseDatetime" id="purchaseDatetime" />
        </div>
        <div class="col-md-6">
            <label for="brand" class="form-label">Бренд</label>
            <select th:field="*{brand}" class="form-select" id="brand" required>
                <option value="">Выберите бренд</option>
                <option th:each="brand : ${brands}" th:value="${brand.id}" th:text="${brand.name}"></option>
            </select>
        </div>
        <input type="hidden" th:value="${enterprise.id}" name="enterprise" />
        <div class="col-md-6">
            <label for="drivers" class="form-label">Список водителей</label>
            <select th:field="*{drivers}" class="selectpicker form-control" id="drivers" multiple data-live-search="true" data-actions-box="true" data-none-selected-text="Не выбрано" data-select-all-text="Выбрать всё" data-deselect-all-text="Снять всё">
                <option th:each="driver : ${drivers}" th:value="${driver.id}" th:text="${driver.lastName + ' ' + driver.firstName}"></option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="activeDriver" class="form-label">Активный водитель</label>
            <select th:field="*{activeDriver}" class="form-select" id="activeDriver">
                <option value="">Выберите водителя</option>
                <option th:each="driver : ${activeDriverPretendents}" th:value="${driver.id}" th:text="${driver.lastName + ' ' + driver.firstName}"></option>
            </select>
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="/api/ui/enterprises" class="btn btn-secondary">К списку предприятий</a>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<script>
    $(document).ready(function() {
        // Инициализация bootstrap-select
        $('.selectpicker').selectpicker();

        const activeDriverSelect = $('#activeDriver');
        const driversSelect = $('#drivers');
        const allPretendents = new Set();

        // Сохраняем список всех возможных активных водителей
        activeDriverSelect.find('option').each(function() {
            if ($(this).val()) {  // Пропускаем пустое значение
                allPretendents.add($(this).val());
            }
        });

        // Функция для обновления списка активных водителей
        function updateActiveDriverOptions() {
            const selectedDrivers = driversSelect.val() || [];
            const currentActiveDriver = activeDriverSelect.data('current-value'); // Получаем текущее значение

            // Очищаем текущий выбор активного водителя
            activeDriverSelect.val('');

            // Если водители не выбраны, блокируем выбор активного водителя
            if (selectedDrivers.length === 0) {
                activeDriverSelect.prop('disabled', true);
                activeDriverSelect.find('option:not(:first)').hide();
                return;
            }

            // Разблокируем выбор активного водителя
            activeDriverSelect.prop('disabled', false);

            // Скрываем все опции кроме первой (placeholder)
            activeDriverSelect.find('option:not(:first)').hide();

            // Показываем только опции, которые есть в списке претендентов и в выбранных водителях
            selectedDrivers.forEach(driverId => {
                if (allPretendents.has(driverId)) {
                    activeDriverSelect.find(`option[value="${driverId}"]`).show();
                }
            });

            // Устанавливаем значение по умолчанию, если оно есть
            if (currentActiveDriver && selectedDrivers.includes(currentActiveDriver)) {
                activeDriverSelect.val(currentActiveDriver);
            }
        }

        // Обновляем список активных водителей при изменении списка водителей
        driversSelect.on('changed.bs.select', updateActiveDriverOptions);

        // Устанавливаем текущее значение активного водителя
        const initialActiveDriver = activeDriverSelect.val();
        activeDriverSelect.data('current-value', initialActiveDriver);

        // Обновляем список активных водителей при загрузке страницы
        updateActiveDriverOptions();
    });
</script>
<script>
    window.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("datetimeInput");
        const utcString = input.dataset.utc;

        if (utcString) {
            // Преобразуем UTC строку в Date объект
            const utcDate = new Date(utcString);

            // Получаем локальное ISO без секунды и миллисекунд
            const localISO = utcDate.toISOString().slice(0, 16);

            // Преобразуем UTC в локальное
            const offset = utcDate.getTimezoneOffset();
            const localDate = new Date(utcDate.getTime() - offset * 60 * 1000);
            const localValue = localDate.toISOString().slice(0, 16);

            input.value = localValue;
        }
    });
</script>
<script>
    document.getElementById("vehicleForm").addEventListener("submit", function (event) {
        const localInput = document.getElementById("datetimeInput");
        const hiddenInput = document.getElementById("purchaseDatetime");

        const localValue = localInput.value; // Пример: "2025-08-04T18:30"
        if (!localValue) return;

        // Создаём Date из локального значения
        const localDate = new Date(localValue);

        // Получаем ISO строку в UTC (с "Z" в конце)
        const utcISOString = localDate.toISOString(); // Пример: "2025-08-04T15:30:00.000Z"

        hiddenInput.value = utcISOString;
    });
</script>
</body>
</html>